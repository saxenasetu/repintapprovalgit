sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/library","vodafone/RepintApprov/repintapproval/util/Services","sap/m/MessageToast","sap/ui/Device"],function(e,t,a,r,i,o,s,n,l){"use strict";return e.extend("vodafone.RepintApprov.repintapproval.controller.Detail",{formatter:a,onInit:function(){var e=this._createViewModel();this.empId=null;this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");var a=this.getModel("detailView");var r=[];var i={};var o={};var s=[];var n=new sap.ui.model.json.JSONModel;var l=new sap.ui.model.json.JSONModel;var g=[];var d={};var u={};var p=new sap.ui.model.json.JSONModel;var c=this;var I=this.getOwnerComponent().getModel("basexsoModel");var m="/RepintEmpHeader(IDSCHEDA="+t+")";var h={async:false,urlParameters:{$expand:"REPERIBILITA,INTERVENTI"},success:function(e,t){console.log("******* EXPAND ******");console.log(e);var a=e.REPERIBILITA.results.length;if(a=="1"){var r="X"}var i=e.INTERVENTI.results.length;if(i=="1"){var s="X"}if(e.STATO=="100"){var g="Da approvare"}var u=c.formatDate(e.ANNOMESE);o={IDSCHEDA:e.IDSCHEDA,MATRICOLA:e.MATRICOLA,COGNOME:e.COGNOME,ANNOMESE:u,Reperibilita:r,Intervento:s,LPN:"",STATO:g,NOME:e.NOME};l.setData(o);c.getView().setModel(l,"RepintEmpHdrModel");for(var p=0;p<e.REPERIBILITA.results.length;p++){if(e.REPERIBILITA.results[p].FLAGNOTTURNO=="1"){var I="X"}var m=c.formatDate(e.REPERIBILITA.results[p].DATAREPERIBILITA);d={DATAREPERIBILITA:m,LPN:I,IDREPERIBILITA:e.REPERIBILITA.results[p].IDREPERIBILITA,no:"1",IDSCHEDA:e.REPERIBILITA.results[p].IDSCHEDA}}n.setData(d);c.getView().byId("idReperibilitaTable").setModel(n,"RepintReperibilitaModel");var h=new sap.ui.model.json.JSONModel;var v=[];var S={};for(var f=0;f<e.INTERVENTI.results.length;f++){S={DATAINTERVENTO:e.INTERVENTI.results[f].DATAINTERVENTO,ORAINIZIO:e.INTERVENTI.results[f].ORAINIZIO,ORAFINE:e.INTERVENTI.results[f].ORAFINE,CHIAMATODA:e.INTERVENTI.results[f].CHIAMATODA,RIP:"Y",CAUSA:e.INTERVENTI.results[f].CAUSA}}h.setData(S);c.getView().byId("idInterventoTable").setModel(h,"RepintInterventiModel")},error:function(e){jQuery.sap.log.getLogger().error("Repint data fetch failed"+e.toString())}};I.read(m,h)},formatDate:function(e){if(e===""||e===undefined||e===null){return""}else{jQuery.sap.require("sap.ui.core.format.DateFormat");var t=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd-MM-yyyy"});return t.format(new Date(e),true)}},_bindView:function(e){var t=this.getModel("detailView")},_createViewModel:function(){return new t({busy:false,delay:0,title:"",noDataText:this.getResourceBundle().getText("notFoundTitle")})},onSelectTableRow:function(e){this.getView().byId("idReperibilitaTitle").setVisible(true);this._busyDialog=new sap.m.BusyDialog({showCancelButton:false});var t={results:[{no:"1",Lpn:"Y",Data:"03-01-2020",OraInizio:"19:30",OraFine:"21:00",Chiamatodo:"NOC",Rip:"",Causa:"WO0000004924724","1h":"","1h2h":"Y","2h4h":"","4h6h":"","6h8h":"","8h":""},{no:"2",Lpn:"N",Data:"03-01-2020",OraInizio:"23:35",OraFine:"01:00",Chiamatodo:"NOC",Rip:"Y",Causa:"WO0000004924776","1h":"","1h2h":"Y","2h4h":"","4h6h":"","6h8h":"","8h":""}]};var a=new sap.ui.model.json.JSONModel(t);a.attachRequestSent(function(){this._busyDialog.open()});a.attachRequestCompleted(function(){this._busyDialog.close()});if(e.getSource().getSelectedItem().getBindingContext().getObject().Intervento==="X"){this.getView().byId("idInterventoTable").setVisible(true);this.getView().byId("idInterventoToolBar").setVisible(true);this.getView().byId("idInterventoTitle").setVisible(true);this.getView().byId("idInterventoTable").setModel(a)}else if(e.getSource().getSelectedItem().getBindingContext().getObject().Intervento===""){this.getView().byId("idInterventoTable").setVisible(false);this.getView().byId("idInterventoToolBar").setVisible(false);this.getView().byId("idInterventoTitle").setVisible(false)}if(e.getSource().getSelectedItem().getBindingContext().getObject().Reperibilita==="X"){this.getView().byId("idReperibilitaTable").setVisible(true);this.getView().byId("idReperibilitaToolBar").setVisible(true);this.getView().byId("idReperibilitaTitle").setVisible(true);this.getView().byId("idReperibilitaTable").setModel(a)}else if(e.getSource().getSelectedItem().getBindingContext().getObject().Reperibilita===""){this.getView().byId("idReperibilitaTable").setVisible(false);this.getView().byId("idReperibilitaToolBar").setVisible(false);this.getView().byId("idReperibilitaTitle").setVisible(false)}},onPressApprove:function(e){var t=this;var a=this.getView().getModel("RepintEmpHdrModel");var r=this.getOwnerComponent().getModel("empModel").getData().name;var i={};i={IDSCHEDA:a.oData.IDSCHEDA,TIMESTAMP:a.oData.ANNOMESE,STATO:"101",ID:r};var o={Object:{Header:i}};this.sServiceUrl=this.getOwnerComponent().getModel().sServiceUrl;var s="/HANAMDC/REPINT/RepintApproval/xsjs/approve.xsjs/?IDEMP="+r+"&idscheda="+a.oData.IDSCHEDA+"&status=101&approvedate=2020-06-08T00:00:00";$.ajax({url:this.sServiceUrl+"/",type:"GET",beforeSend:function(e){e.setRequestHeader("X-CSRF-Token","Fetch")},success:function(e,t,a){var r=a.getResponseHeader("X-CSRF-Token");$.ajax({url:s,type:"POST",contentType:"application/json",data:JSON.stringify(o),beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",r)},success:function(e,t,a){console.log("*********** SUCCESS ******************");console.log(e);console.log(t);that.refreshAPP()},error:function(e,t,a){console.log("Error in DeepInsert");MessageBox.error("Error while perfoming Salva operation");jQuery.sap.log.getLogger().error("RepintCambioResponsabile data fetch failed"+t.toString());console.log(t)}})}})},refreshAPP:function(e){var t=sap.ui.getCore().byId("master--list");var a=t.getSelectedItem();var r=a.getBindingContext();var i=r.getObject();var o=r.getPath();var s=parseInt(o.slice(-1));var n=t.getModel().getData();if(s!==-1){var l=t.getModel();var g=l.getData();var d=g.splice(s,1);l.setData(g)}else{alert("Please select a row")}t.getModel().setProperty("/",n);t.removeSelections();var u=sap.ui.getCore().byId("detail");var p=this.getView().byId("oHeader");u.setBindingContext(null);p.setBindingContext(null)},onPressReject:function(e){var t=this;var a=this.getView().getModel("RepintEmpHdrModel");var r=this.getOwnerComponent().getModel("empModel").getData().name;var i={};i={IDSCHEDA:a.oData.IDSCHEDA,TIMESTAMP:a.oData.ANNOMESE,STATO:"201",ID:r};var o={Object:{Header:i}};this.sServiceUrl=this.getOwnerComponent().getModel().sServiceUrl;var s="/HANAMDC/REPINT/RepintApproval/xsjs/reject.xsjs";$.ajax({url:this.sServiceUrl+"/",type:"GET",beforeSend:function(e){e.setRequestHeader("X-CSRF-Token","Fetch")},success:function(e,t,a){var r=a.getResponseHeader("X-CSRF-Token");$.ajax({url:s,type:"POST",contentType:"application/json",data:JSON.stringify(o),beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",r)},success:function(e,t,a){console.log("*********** SUCCESS ******************");console.log(e);console.log(t);that.refreshAPP()},error:function(e,t,a){console.log("Error in DeepInsert");MessageBox.error("Error while perfoming Salva operation");jQuery.sap.log.getLogger().error("RepintCambioResponsabile data fetch failed"+t.toString());console.log(t)}})}})},onPressGestisciDelegati:function(e){var t=!l.system.phone;this.getRouter().navTo("GestisciDelegati")},onPressGestioneCalcoloeregole:function(e){var t=!l.system.phone;this.getRouter().navTo("GestioneCalcoloeregole")},handleEmpSearchDialog:function(e){var t=this;t.inputId=e.getSource().getId();t.selectedUserItem=undefined;if(!t._valueHelpUserDialog){t._valueHelpUserDialog=sap.ui.xmlfragment("vodafone.RepintApprov.repintapproval.view.EmpSearchDialog",t);t.getView().addDependent(t._valueHelpUserDialog)}t._valueHelpUserDialog.open()},onSearchEmpSearch:function(e){var t;var a;var r;var i=e.getSource().getParent().getParent().getParent().getContent()[1];if(e.getSource().getParent().getItems()[0].getValue()===""){t=undefined}else{t=e.getSource().getParent().getItems()[0].getValue()}if(e.getSource().getParent().getItems()[1].getValue()===""){a=undefined}else{a=e.getSource().getParent().getItems()[1].getValue()}if(e.getSource().getParent().getItems()[2].getValue()===""){r=undefined}else{r=e.getSource().getParent().getItems()[2].getValue()}var o={results:[{FirstName:"Valerio",LastName:"Ferrari",EmpId:"1111"},{FirstName:"Kapil",LastName:"Sharma",EmpId:"2222"},{FirstName:"Francesca",LastName:"Signoroni",EmpId:"3333"},{FirstName:"Jay",LastName:"Singh",EmpId:"4444"},{FirstName:"Gianni",LastName:"Guttuso",EmpId:"5555"},{FirstName:"Gianni",LastName:"Guttuso1",EmpId:"6666"},{FirstName:"Kapil",LastName:"Sharma1",EmpId:"7777"},{FirstName:"Valerio",LastName:"Ferrari1",EmpId:"8888"},{FirstName:"Francesca",LastName:"Signoroni1",EmpId:"9999"},{FirstName:"Jay",LastName:"Singh1",EmpId:"1010"}]};var s=new sap.ui.model.json.JSONModel(o);this.getView().setModel(s,"EmpDataModel");var n=this.getView().getModel("EmpDataModel").getData().results.filter(function(e,i){if(e.EmpId.includes(r)||e.FirstName.includes(t)||e.LastName.includes(a)){return e}});var l=new sap.ui.model.json.JSONModel(n);i.setModel(l);var g=new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{FirstName}"}),new sap.m.Text({text:"{LastName}"}),new sap.m.Text({text:"{EmpId}"})]});i.bindAggregation("items","/",g)},onResetEmpSearch:function(e){var t=this;var a=e.getSource().getParent().getParent().getParent().getContent()[1];var r=e.getSource().getParent().getItems()[0];var i=e.getSource().getParent().getItems()[1];var o=e.getSource().getParent().getItems()[2];var s=new sap.ui.model.json.JSONModel;s.setData({});a.setModel(s);r.setValue("");i.setValue("");o.setValue("");t.selectedUserItem=undefined},onUserSelectionValueHelpUserPress:function(e){var t=this;t.selectedUserItem=e.getSource().getSelectedItem()},onOkValueHelpUserDialog:function(){var e=this;if(!e.selectedUserItem){n.show(e.getOwnerComponent().getModel("i18n").getResourceBundle().getText("msgSelectUser"));return}var t=e.selectedUserItem.getCells()[0].getText()+" "+e.selectedUserItem.getCells()[1].getText();var a=e.selectedUserItem.getCells()[2].getText();var r=e.getOwnerComponent().getModel("i18n").getResourceBundle().getText("forwardConfirmation",[t]);n.show(r);e._valueHelpUserDialog.close()},onCloseValueHelpUserDialog:function(){var e=this;e._valueHelpUserDialog.close()},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var a=t.getPath(),r=this.getResourceBundle(),i=e.getModel().getObject(a),o=i.EmployeeID,s=i.Address,n=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(a);n.setProperty("/shareSendEmailSubject",r.getText("shareSendEmailObjectSubject",[o]));n.setProperty("/shareSendEmailMessage",r.getText("shareSendEmailObjectMessage",[s,o,location.href]))},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView");t.setProperty("/delay",0);t.setProperty("/busy",true);t.setProperty("/delay",e)},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}}})});
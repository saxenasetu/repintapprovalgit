sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/GroupHeaderListItem","sap/ui/Device","sap/ui/core/Fragment","../model/formatter"],function(e,t,i,r,o,a,s,n,l){"use strict";return e.extend("vodafone.RepintApprov.repintapproval.controller.Master",{formatter:l,onInit:function(){var e=this.byId("list"),t=this._createViewModel(),i=e.getBusyIndicatorDelay();var r=this;r.getAuthorization();this._oGroupFunctions={repintID:function(e){var t=e.getProperty("repintID"),i,r;if(t<=1e3){i="LE1000";r=this.getResourceBundle().getText("masterGroup1Header1")}else{i="GT1000";r=this.getResourceBundle().getText("masterGroup1Header2")}return{key:i,text:r}}.bind(this)};var o=this.getOwnerComponent().getModel("DataModel");this.getView().byId("list").setModel(o);this._oList=e;this._oListFilterState={aFilter:[],aSearch:[]};this.setModel(t,"masterView");e.attachEventOnce("updateFinished",function(){t.setProperty("/delay",i)});this.getView().addEventDelegate({onBeforeFirstShow:function(){this.getOwnerComponent().oListSelector.setBoundMasterList(e)}.bind(this)});this.getRouter().getRoute("master").attachPatternMatched(this._onMasterMatched,this);this.getRouter().attachBypassed(this.onBypassed,this)},onUpdateFinished:function(e){this._updateListItemCount(e.getParameter("total"))},formatDate:function(e){if(e===""||e===undefined||e===null){return""}else{jQuery.sap.require("sap.ui.core.format.DateFormat");var t=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd-MM-yyyy"});return t.format(new Date(e),true)}},getAuthorization:function(){var e=this.getOwnerComponent().getModel("empModel").getData().name;var t=this;var i="/HANAMDC/REPINT/RepintApproval/xsjs/getAuthorization.xsjs/?aEmpid="+e+"";$.ajax({url:i,success:function(i,r){console.log(i);t.getMasterList(e)},error:function(e,t,i){jQuery.sap.log.getLogger().error("Get Employee Authorization fetch failed"+i.toString())}})},getMasterList:function(e){var t=[];var i={};var r={};var o=new sap.ui.model.json.JSONModel;var a=this;var s="/HANAMDC/REPINT/RepintApproval/xsjs/getMasterList.xsjs/?aEmpid="+e+"";var a=this;$.ajax({url:s,success:function(e,r){console.log(e);for(var s=0;s<e.length;++s){var n=e[s].NOME+e[s].COGNOME;var l=a.formatDate(e[s].ANNOMESE);if(e[s].STATO=="100"){var u="Da approvare"}i={repintID:e[s].IDSCHEDA,totale:e[s].TOTALE_EROGATO,repint:n,Status:u,Scheda:l};t.push(i);i={}}o.setData(t);a.getView().byId("list").setModel(o,"repintMasterModel")},error:function(e,t,i){jQuery.sap.log.getLogger().error("Employee Authorization failed "+i.toString());var r=new sap.m.BusyDialog;r.open();sap.ui.core.UIComponent.getRouterFor(a).navTo("Unauthorized");r.close()}});var n=new sap.ui.model.json.JSONModel(r);this.setModel(n,"DataModel")},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh();return}var t=e.getParameter("query");if(t){this._oListFilterState.aSearch=[new i({filters:[new i("repint",o.Contains,t),new i("repintID",o.Contains,t),new i("Status",o.Contains,t)],and:false})]}else{this._oListFilterState.aSearch=[]}this._applyFilterSearch()},onRefresh:function(){this._oList.getBinding("items").refresh()},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var i=e.getSource().getId();if(i.match("sort")){t="sort"}else if(i.match("group")){t="group"}}if(!this.byId("viewSettingsDialog")){n.load({id:this.getView().getId(),name:"vodafone.RepintApprov.repintapproval.view.ViewSettingsDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialog").open(t)}},onConfirmViewSettingsDialog:function(e){var t=e.getParameters().filterItems,r=[],a=[];t.forEach(function(e){switch(e.getKey()){case"Filter1":r.push(new i("repintID",o.LE,1e3));break;case"Filter2":r.push(new i("repintID",o.GT,1e3));break;default:break}a.push(e.getText())});this._oListFilterState.aFilter=r;this._updateFilterBar(a.join(", "));this._applyFilterSearch();this._applySortGroup(e)},_applySortGroup:function(e){var t=e.getParameters(),i,o,a=[];if(t.groupItem){i=t.groupItem.getKey();o=t.groupDescending;var s=this._oGroupFunctions[i];a.push(new r(i,o,s))}i=t.sortItem.getKey();o=t.sortDescending;a.push(new r(i,o));this._oList.getBinding("items").sort(a)},onSelectionChange:function(e){var t=e.getSource(),i=e.getParameter("selected");if(!(t.getMode()==="MultiSelect"&&!i)){this._showDetail(e.getParameter("listItem")||e.getSource())}},onBypassed:function(){this._oList.removeSelections(true)},createGroupHeader:function(e){return new a({title:e.text,upperCase:false})},onNavBack:function(){history.go(-1)},_createViewModel:function(){return new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("masterTitleCount",[0]),noDataText:this.getResourceBundle().getText("masterListNoDataText"),sortBy:"repintID",groupBy:"None"})},_onMasterMatched:function(){this.getModel("appView").setProperty("/layout","OneColumn")},_showDetail:function(e){var t=!s.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{objectId:e.getBindingContext("repintMasterModel").getProperty("repintID")},t)},_updateListItemCount:function(e){var t;if(this._oList.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("masterTitleCount",[e]);this.getModel("masterView").setProperty("/title",t)}},_applyFilterSearch:function(){var e=this._oListFilterState.aSearch.concat(this._oListFilterState.aFilter),t=this.getModel("masterView");this._oList.getBinding("items").filter(e,"Application");if(e.length!==0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.aSearch.length>0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataText"))}},_updateFilterBar:function(e){var t=this.getModel("masterView");t.setProperty("/isFilterBarVisible",this._oListFilterState.aFilter.length>0);t.setProperty("/filterBarLabel",this.getResourceBundle().getText("masterFilterBarText",[e]))}})});